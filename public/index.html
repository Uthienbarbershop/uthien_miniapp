<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ƒê√°nh gi√° th·ª£ c·∫Øt t√≥c</title>
  <link rel="stylesheet" href="barber.css" />
  <style>
    /* CSS ƒë·ªÉ hi·ªÉn th·ªã placeholder sao v√† con tr·ªè */
    .star-rating label {
      cursor: pointer;
      color: lightgray; /* M√†u m·∫∑c ƒë·ªãnh cho c√°c sao ch∆∞a ch·ªçn */
    }
    .star-rating input:checked ~ label {
      color: gold; /* M√†u cho sao ƒë√£ ch·ªçn v√† c√°c sao ph√≠a tr∆∞·ªõc */
    }
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: gold; /* M√†u khi di chu·ªôt qua sao */
    }

    /* CSS m·ªõi cho ph·∫ßn t√≥m t·∫Øt ƒë√°nh gi√° */
    .review-summary {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      background-color: #f9f9f9;
    }

    .summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .average-rating {
      font-size: 2.5em;
      font-weight: bold;
      color: #333;
    }

    .total-reviews {
      font-size: 0.9em;
      color: #666;
    }

    .rating-breakdown .rating-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }

    .rating-breakdown .star-number {
      width: 20px; /* Chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho s·ªë sao */
      font-weight: bold;
      margin-right: 5px;
    }

    .rating-breakdown .progress-bar-container {
      flex-grow: 1; /* Chi·∫øm h·∫øt kh√¥ng gian c√≤n l·∫°i */
      background-color: #e0e0e0;
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
      margin: 0 10px;
    }

    .rating-breakdown .progress-bar {
      height: 100%;
      background-color: #28a745; /* M√†u xanh l√° c√¢y */
      width: 0%; /* S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS */
      border-radius: 5px;
    }

    .rating-breakdown .percentage {
      width: 40px; /* Chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho ph·∫ßn trƒÉm */
      text-align: right;
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <h2 style="color: #28a745;">üí¨ ƒê√°nh gi√° sau khi tr·∫£i nghi·ªám</h2>

  <div class="review-summary">
    <h3>T√≥m t·∫Øt ƒë√°nh gi√°</h3>
    <div class="summary-header">
      <div class="average-rating" id="averageRating">--</div>
      <div>
        <div class="stars-display" id="summaryStars"></div>
        <div class="total-reviews" id="totalReviews">-- ƒë√°nh gi√°</div>
      </div>
    </div>
    <div class="rating-breakdown" id="ratingBreakdown">
      </div>
  </div>

  <h3>ƒê√°nh gi√° th·ª£ c·∫Øt t√≥c</h3>
  <form id="reviewForm">
    <div class="star-rating">
      <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="Tuy·ªát v·ªùi">‚òÖ</label>
      <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="R·∫•t t·ªët">‚òÖ</label>
      <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="T·ªët">‚òÖ</label>
      <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="Trung b√¨nh">‚òÖ</label>
      <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="T·ªá">‚òÖ</label>
    </div>

    <textarea id="comment" placeholder="Vi·∫øt nh·∫≠n x√©t c·ªßa b·∫°n..." rows="3" required></textarea><br>

    <input type="hidden" id="customer_id" value="12345" />
    <input type="hidden" id="barber_id" value="67890" />

    <button type="submit" id="submitReview">G·ª≠i ƒë√°nh gi√°</button>
    <div id="message" style="margin-top: 10px; color: red;"></div>
  </form>

  <h3>üìã ƒê√°nh gi√° c·ªßa kh√°ch tr∆∞·ªõc ƒë√≥</h3>
  <div id="reviewList">
    <p>ƒêang t·∫£i ƒë√°nh gi√°...</p>
  </div>

  <script>
    // H√†m hi·ªÉn th·ªã th√¥ng b√°o
    function showMessage(msg, type = 'error') {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = msg;
      messageDiv.style.color = type === 'success' ? 'green' : 'red';
      messageDiv.style.display = 'block';
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }

    document.getElementById("reviewForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const rating = document.querySelector("input[name='rating']:checked")?.value;
      const comment = document.getElementById("comment").value.trim();

      const customerId = document.getElementById("customer_id").value;
      const barberId = document.getElementById("barber_id").value;

      if (!rating) {
        showMessage("Vui l√≤ng ch·ªçn sao ƒë·ªÉ ƒë√°nh gi√°.", 'error');
        return;
      }
      if (!comment) {
        showMessage("Vui l√≤ng nh·∫≠p nh·∫≠n x√©t c·ªßa b·∫°n.", 'error');
        return;
      }

      const data = { customer_id: customerId, barber_id: barberId, rating, comment };

      fetch("/api/review", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      })
        .then((res) => {
          if (!res.ok) {
            return res.json().then(errorData => {
              throw new Error(errorData.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi g·ª≠i ƒë√°nh gi√°.");
            });
          }
          return res.json();
        })
        .then((result) => {
          showMessage(result.message || "ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!", 'success');
          document.getElementById("reviewForm").reset();
          document.querySelectorAll('.star-rating label').forEach(label => label.style.color = 'lightgray');
          loadReviews(); // T·∫£i l·∫°i danh s√°ch ƒë√°nh gi√° sau khi g·ª≠i th√†nh c√¥ng v√† c·∫≠p nh·∫≠t t√≥m t·∫Øt
        })
        .catch((err) => {
          showMessage(`C√≥ l·ªói khi g·ª≠i ƒë√°nh gi√°: ${err.message}`, 'error');
          console.error("L·ªói g·ª≠i ƒë√°nh gi√°:", err);
        });
    });

    function loadReviews() {
      const barberId = document.getElementById("barber_id").value;
      const reviewList = document.getElementById("reviewList");
      reviewList.innerHTML = "<p>ƒêang t·∫£i ƒë√°nh gi√°...</p>";

      // Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i cho t√≥m t·∫Øt
      document.getElementById("averageRating").textContent = "--";
      document.getElementById("summaryStars").innerHTML = "";
      document.getElementById("totalReviews").textContent = "-- ƒë√°nh gi√°";
      document.getElementById("ratingBreakdown").innerHTML = "";


      fetch("/api/reviews/" + barberId)
        .then((res) => {
          if (!res.ok) {
            throw new Error(`L·ªói HTTP: ${res.status}`);
          }
          return res.json();
        })
        .then((data) => {
          // X√≥a th√¥ng b√°o t·∫£i
          reviewList.innerHTML = "";

          if (data.length === 0) {
            reviewList.innerHTML = "<p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>";
            // Reset t√≥m t·∫Øt n·∫øu kh√¥ng c√≥ ƒë√°nh gi√°
            document.getElementById("averageRating").textContent = "0.0";
            document.getElementById("summaryStars").innerHTML = '‚òÜ'.repeat(5);
            document.getElementById("totalReviews").textContent = "0 ƒë√°nh gi√°";
            document.getElementById("ratingBreakdown").innerHTML = "<p>Ch∆∞a c√≥ d·ªØ li·ªáu ƒë√°nh gi√° sao.</p>";
            return;
          }

          // C·∫≠p nh·∫≠t t√≥m t·∫Øt ƒë√°nh gi√°
          updateReviewSummary(data);

          // S·∫Øp x·∫øp ƒë√°nh gi√° theo th·ªùi gian m·ªõi nh·∫•t l√™n ƒë·∫ßu
          data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

          data.forEach((review) => {
            const item = document.createElement("div");
            item.classList.add("review-item");
            const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
            item.innerHTML =
              `<p><strong>ƒê√°nh gi√°: ${stars}</strong></p>
              <p>${review.comment}</p>
              <p><em>Th·ªùi gian: ${new Date(review.created_at).toLocaleString('vi-VN')}</em></p>
              <hr>`;
            reviewList.appendChild(item);
          });
        })
        .catch((err) => {
          reviewList.innerHTML = "<p>Kh√¥ng th·ªÉ t·∫£i ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i sau.</p>";
          console.error("L·ªói t·∫£i ƒë√°nh gi√°:", err);
          // Reset t√≥m t·∫Øt n·∫øu c√≥ l·ªói t·∫£i
          document.getElementById("averageRating").textContent = "L·ªói";
          document.getElementById("summaryStars").innerHTML = "";
          document.getElementById("totalReviews").textContent = "L·ªói t·∫£i";
          document.getElementById("ratingBreakdown").innerHTML = "<p>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒë√°nh gi√° sao.</p>";
        });
    }

    // H√†m m·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t t√≥m t·∫Øt ƒë√°nh gi√°
    function updateReviewSummary(reviews) {
      const totalReviewsCount = reviews.length;
      let totalRatingSum = 0;
      const ratingCounts = { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 };

      reviews.forEach(review => {
        totalRatingSum += parseInt(review.rating);
        ratingCounts[review.rating]++;
      });

      const averageRating = totalReviewsCount > 0 ? (totalRatingSum / totalReviewsCount).toFixed(1) : 0;

      // C·∫≠p nh·∫≠t ƒëi·ªÉm trung b√¨nh v√† t·ªïng s·ªë ƒë√°nh gi√°
      document.getElementById("averageRating").textContent = averageRating;
      document.getElementById("totalReviews").textContent = `${totalReviewsCount} ƒë√°nh gi√°`;

      // C·∫≠p nh·∫≠t sao trung b√¨nh (v√≠ d·ª•: 4.8 sao s·∫Ω l√† 4 sao ƒë·∫∑c v√† 1 sao r·ªóng)
      const fullStars = Math.floor(averageRating);
      const halfStar = averageRating - fullStars >= 0.5 ? 1 : 0;
      const emptyStars = 5 - fullStars - halfStar;
      let summaryStarsHtml = '‚òÖ'.repeat(fullStars);
      if (halfStar) summaryStarsHtml += '¬Ω'; // S·ª≠ d·ª•ng k√Ω t·ª± sao r·ªóng n·∫øu c√≥
      summaryStarsHtml += '‚òÜ'.repeat(emptyStars);
      document.getElementById("summaryStars").innerHTML = summaryStarsHtml;


      // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì ph√¢n t√≠ch ƒë√°nh gi√°
      const ratingBreakdownDiv = document.getElementById("ratingBreakdown");
      ratingBreakdownDiv.innerHTML = ''; // X√≥a n·ªôi dung c≈©

      for (let i = 5; i >= 1; i--) { // Duy·ªát t·ª´ 5 sao xu·ªëng 1 sao
        const count = ratingCounts[i.toString()] || 0;
        const percentage = totalReviewsCount > 0 ? ((count / totalReviewsCount) * 100).toFixed(0) : 0; // L√†m tr√≤n kh√¥ng c√≥ s·ªë th·∫≠p ph√¢n

        const row = document.createElement("div");
        row.classList.add("rating-row");
        row.innerHTML = `
          <span class="star-number">${i}</span>
          <div class="progress-bar-container">
            <div class="progress-bar" style="width: ${percentage}%;"></div>
          </div>
          <span class="percentage">${percentage}%</span>
        `;
        ratingBreakdownDiv.appendChild(row);
      }
    }

    // T·ª± ƒë·ªông t·∫£i khi trang load
    window.onload = loadReviews;
  </script>
</body>
</html>